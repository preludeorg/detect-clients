name: Deploy (install / demo / nocturnal / raindrop scripts)
description: Copy script to s3
inputs:
  environment:
    description: "Describe the environment for slack webhooks"
  s3_bucket:
    description: 'Where to push probes'
    required: true
  aws_region:
    description: 'Region to set for aws access'
    required: true
  aws_access_key_id:
    description: 'Access key to use'
    required: true
  aws_secret_access_key:
    description: 'Secret key to use'
    required: true
  slack_workflow_url:
    description: 'Where to send the slack webhook'
    required: true

runs:
  using: "composite"
  steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@567d4149d67f15f52b09796bea6573fc32952783
      # uses: aws-actions/configure-aws-credentials@v1-node16
      with:
        aws-region: ${{ inputs.aws_region }}
        aws-access-key-id: ${{ inputs.aws_access_key_id }}
        aws-secret-access-key: ${{ inputs.aws_secret_access_key }}

    - name: Copy files to the s3 with the AWS CLI
      shell: bash
      run: |
        aws s3 cp shell/probe/raindrop.ps1 s3://${{ inputs.s3_bucket }}/prelude/probes/raindrop/raindrop_windows-x86_64
        
        ARCHS=(darwin-arm64 darwin-x86_64 linux-arm64 linux-x86_64)        
        DEMOS=($(seq 1 5))

        for i in ${DEMOS[@]}; do 
          aws s3 cp shell/demo/demo${i}.ps1 s3://bucket/prelude/probes/demo${i}/demo${i}_windows-x86_64
        done

        for a in ${ARCHS[@]}; do  
          aws s3 cp shell/probe/nocturnal.sh s3://bucket/shell/probe/nocturnal_${a}
        done 

        for i in ${DEMOS[@]}; do
          for a in ${ARCHS[@]}; do
            aws s3 cp shell/demo/demo${i}.sh s3://bucket/prelude/probes/demo${i}/demo${i}_${a}
          done 
        done

    - name: Send custom JSON data to Slack workflow
      if: inputs.environment == 'prod' && always()
      id: slack
      uses: slackapi/slack-github-action@v1.23.0
      with:
        payload: |
          {
            "repo": "${{ github.repository }}",
            "env": "${{ inputs.environment }}",
            "user": "${{ github.triggering_actor }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "status": "${{ job.status }}",
            "job_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "event_name": "${{ github.event_name }}",
            "event_action": "${{ github.event.action }}"
          }
      env:
        SLACK_WEBHOOK_URL: ${{ inputs.slack_workflow_url }}
